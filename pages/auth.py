import streamlit as st
import sys
import os

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))
from services.auth_service import login_user, register_user, logout_user

st.set_page_config(page_title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", page_icon="ğŸ”")

# --- Check Login Status ---
if "logged_in" not in st.session_state:
    st.session_state.logged_in = False

if st.session_state.logged_in:
    st.success(f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ {st.session_state.username}!")
    if st.button("Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©"):
        st.switch_page("pages/chat.py")
    if st.button("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"):
        logout_user()
    st.stop()

# --- UI ---
st.title("ğŸ” Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„")

tab1, tab2 = st.tabs(["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"])

with tab1:  # Login
    st.subheader("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
    with st.form("login_form"):
        email = st.text_input("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
        password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
        if st.form_submit_button("Ø¯Ø®ÙˆÙ„"):
            if login_user(email, password):
                st.success("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
                st.switch_page("pages/chat.py")
            else:
                st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.")

with tab2:  # Signup
    st.subheader("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯")
    with st.form("signup_form"):
        new_email = st.text_input("Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…")
        new_pass = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
        email = st.text_input("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
        if st.form_submit_button("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨"):
            success, msg = register_user(new_email, new_pass, email)
            if success:
                st.success(msg)
            else:
                st.error(msg)
